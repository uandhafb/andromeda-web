<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Modular Strudel Score — Andromeda Stars (Image Always Visible)</title>
  <style>
    body {
      margin: 0; background: #000; color: #eee; font-family: monospace;
      height: 100vh; display: grid; grid-template-columns: 1fr 1fr; overflow: hidden;
    }
    iframe { border: none; width: 100%; height: 100%; }

    #right { position: relative; background: #050505; overflow: hidden; }

    /* We keep the <img> only to LOAD the file and get naturalWidth/Height.
       We draw it onto the canvas each frame, so we can hide it. */
    #bg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      opacity: 0;           /* ✅ hide DOM image */
      pointer-events: none;
    }

    canvas {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      display: block;
    }

    #overlay {
      position: absolute; inset: 0; background: rgba(0,0,0,0.9);
      display: flex; justify-content: center; align-items: center; z-index: 100;
    }
    button {
      padding: 15px 30px; font-size: 18px; cursor: pointer;
      background: #222; color: #0f6; border: 1px solid #0f6;
    }

    #log {
      position: absolute; top: 10px; left: 10px; font-size: 10px; color: #0f6;
      background: rgba(0,0,0,0.8); padding: 6px 8px; pointer-events: none;
      z-index: 10; white-space: pre; max-width: 95%;
    }
  </style>
</head>
<body>

  <div id="overlay"><button onclick="startAll()">INITIALIZE MODULES</button></div>

  <iframe id="strudel-frame" src="https://strudel.cc/" allow="autoplay; midi"></iframe>

  <div id="right">
    <div id="log">System Offline</div>

    <!-- ✅ IMPORTANT: file must be next to this HTML -->
    <img id="bg" src="/andromeda.png" alt="Andromeda drawing">

    <canvas id="c"></canvas>
  </div>

  <script>
    // =========================================================
    // GLOBAL STATE
    // =========================================================
    const canvas = document.getElementById("c");
    const ctx = canvas.getContext("2d");
    const logger = document.getElementById("log");
    const frame = document.getElementById("strudel-frame");
    const img = document.getElementById("bg");

    function log(msg) { logger.textContent = `LOG: ${msg}`; console.log(msg); }

    // ⭐ Your anchors (normalized to the IMAGE area)
    const anchors = [
      { x: 0.5957, y: 0.3649 },
      { x: 0.4739, y: 0.2574 },
      { x: 0.4815, y: 0.1266 },
      { x: 0.3630, y: 0.7717 },
      { x: 0.3554, y: 0.7121 },
      { x: 0.7848, y: 0.4608 },
      { x: 0.7402, y: 0.6976 },
      { x: 0.4761, y: 0.3707 },
      { x: 0.3696, y: 0.2995 },
    ];

    // One star per anchor, controlled by MIDI channels 1..9
    const stars = anchors.map((a, i) => ({
      id: i + 1,
      ax: 0, ay: 0,
      x: 0, y: 0,
      vx: 0, vy: 0,
      baseR: 8 + Math.random() * 6,
      r: 10,
      energy: 0,
      orbitMax: 26 + Math.random() * 18,
    }));

    // We keep the computed displayed image rect here
    let imgRect = null;

    // =========================================================
    // IMAGE RECT for object-fit: contain (used for mapping + drawing)
    // =========================================================
    function computeDisplayedImageRect() {
      const W = canvas.width;
      const H = canvas.height;

      const iw = img.naturalWidth;
      const ih = img.naturalHeight;
      if (!iw || !ih) return null;

      const imageAspect = iw / ih;
      const canvasAspect = W / H;

      let drawW, drawH, offsetX, offsetY;

      if (imageAspect > canvasAspect) {
        drawW = W;
        drawH = W / imageAspect;
        offsetX = 0;
        offsetY = (H - drawH) / 2;
      } else {
        drawH = H;
        drawW = H * imageAspect;
        offsetY = 0;
        offsetX = (W - drawW) / 2;
      }

      return { x: offsetX, y: offsetY, w: drawW, h: drawH };
    }

    // =========================================================
    // MIDI ENGINE
    // =========================================================
    async function initMIDI() {
      try {
        const midi = await navigator.requestMIDIAccess();
        let any = false;

        for (let input of midi.inputs.values()) {
          any = true;
          input.onmidimessage = handleMIDIMessage;
          log(`MIDI Online | Listening: ${input.name}`);
        }
        if (!any) log("MIDI Online, but no inputs detected (enable Strudel MIDI OUT).");
      } catch (e) {
        log("MIDI Failed: " + e);
      }
    }

    function handleMIDIMessage(msg) {
      const [status, data1, data2] = msg.data;
      const type = status & 0xf0;
      const channel = (status & 0x0f) + 1;

      // Note on
      if (type === 0x90 && data2 > 0) {
        const vel = data2 / 127;
        triggerStar(channel, vel);
      }
    }

    function triggerStar(channel, vel) {
      if (channel < 1 || channel > stars.length) return;
      const s = stars[channel - 1];

      s.energy = Math.max(s.energy, vel);

      const angle = Math.random() * Math.PI * 2;
      const push = vel * 18;
      s.vx += Math.cos(angle) * push;
      s.vy += Math.sin(angle) * push;

      s.r = s.baseR + vel * 30;

      log(`Star ${s.id} (MIDI ch ${channel}) | vel ${vel.toFixed(2)}`);
    }

    // =========================================================
    // DRAWING + ANIMATION
    // =========================================================
    function drawBackgroundImage() {
      if (!imgRect) return;

      // Clear fully each frame so image stays visible (no accumulating black layer)
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw the constellation image inside the canvas
      ctx.drawImage(img, imgRect.x, imgRect.y, imgRect.w, imgRect.h);

      // Optional: darken it slightly so stars pop (adjust alpha)
      ctx.fillStyle = "rgba(0,0,0,0.35)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function drawConstellationLines() {
      ctx.beginPath();
      ctx.strokeStyle = "rgba(180,200,255,0.22)";
      ctx.lineWidth = 1;

      // connect in your click order
      for (let i = 0; i < stars.length - 1; i++) {
        ctx.moveTo(stars[i].ax, stars[i].ay);
        ctx.lineTo(stars[i + 1].ax, stars[i + 1].ay);
      }
      ctx.stroke();
    }

    function animate() {
      drawBackgroundImage();
      drawConstellationLines();

      for (const s of stars) {
        // spring towards anchor
        const dx = s.ax - s.x;
        const dy = s.ay - s.y;
        s.vx += dx * 0.004;
        s.vy += dy * 0.004;

        // keep near anchor
        const ox = s.x - s.ax;
        const oy = s.y - s.ay;
        const dist = Math.hypot(ox, oy);
        if (dist > s.orbitMax && dist > 0.0001) {
          const pull = (dist - s.orbitMax) * 0.02;
          s.vx -= (ox / dist) * pull;
          s.vy -= (oy / dist) * pull;
        }

        s.x += s.vx;
        s.y += s.vy;
        s.vx *= 0.92;
        s.vy *= 0.92;

        // decay
        s.energy *= 0.92;
        const targetR = s.baseR + s.energy * 30;
        s.r = s.r * 0.9 + targetR * 0.1;

        // glow + core
        ctx.beginPath();
        ctx.fillStyle = "rgba(190,220,255,0.16)";
        ctx.arc(s.x, s.y, s.r * 2.4, 0, Math.PI * 2);
        ctx.fill();

        ctx.beginPath();
        ctx.fillStyle = "rgba(210,235,255,0.95)";
        ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
        ctx.fill();
      }

      requestAnimationFrame(animate);
    }

    // =========================================================
    // RESIZE: map anchors into displayed image rect
    // =========================================================
    function resize() {
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;

      imgRect = computeDisplayedImageRect();
      if (!imgRect) return;

      for (let i = 0; i < stars.length; i++) {
        const a = anchors[i];
        const s = stars[i];

        s.ax = imgRect.x + a.x * imgRect.w;
        s.ay = imgRect.y + a.y * imgRect.h;

        if (s.x === 0 && s.y === 0) {
          s.x = s.ax;
          s.y = s.ay;
        }
      }
    }
    window.addEventListener("resize", resize);

    // =========================================================
    // INIT
    // =========================================================
    function startAll() {
      document.getElementById("overlay").style.display = "none";
      resize();
      initMIDI();
      animate();
      log("Started (image drawn on canvas).");
    }

    img.addEventListener("load", () => {
      log(`Image loaded: ${img.naturalWidth}x${img.naturalHeight}`);
      resize();
    });
    img.addEventListener("error", () => log("IMAGE ERROR: can't load ./andromeda.png (check filename/path)."));

    if (img.complete && img.naturalWidth) resize();
  </script>
</body>
</html>

